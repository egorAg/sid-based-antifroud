# SID-based Anti-Fraud Service

🚨 Лёгкая антифрод-система для выявления мультиаккаунтов и защиты от
спама запросами --- построена на NestJS + Fastify + Drizzle ORM +
Redis + PostgreSQL.

## 📌 Оглавление

-   [Описание](#описание)
-   [Задача, которую решает сервис](#задача-которую-решает-сервис)
-   [Как работает антифрод](#как-работает-антифрод)
-   [Архитектура и стек](#архитектура-и-стек)
-   [Основные компоненты](#основные-компоненты)
-   [Флоу запроса](#флоу-запроса)
-   [Диаграмма последовательности](#диаграмма-последовательности)
-   [ERD Диаграмма](#erd-диаграмма)
-   [Роуты](#роуты)
-   [Запуск проекта](#запуск-проекта)
-   [Переменные окружения](#переменные-окружения)
-   [Разработка и миграции (Drizzle)](#разработка-и-миграции-drizzle)
-   [Заметки по безопасности](#заметки-по-безопасности)
-   [Ограничения и будущее развитие](#ограничения-и-будущее-развитие)

------------------------------------------------------------------------

# 🧠 Описание

Сервис реализует лёгкий антифрод-уровень, основанный на **SID** ---
идентификаторе браузера, хранящемся в cookie.

Он помогает выявлять: - мультиаккаунтеров, - пользователей, которые
заходят под разными учетками, - простейшие обходы безопасности, -
скрипты, которые спамят запросами.

------------------------------------------------------------------------

# 🎯 Задача, которую решает сервис

Раньше при каждом запросе создавался новый SID и записывался в БД.\
Если пользователь запускал агрессивный скрипт --- БД раздувалась **до
миллионов записей**.

Наш сервис решает проблему за счёт: - **Redis-lock'ов**, которые не дают
спамить привязками, - уникального `(userId, sid)` сочетания, -
throttling'a SID-привязок.

------------------------------------------------------------------------

# 🔥 Как работает антифрод

### 1. Генерация SID

Если у пользователя в cookie нет `sid`, создаётся новый `nanoid(21)` и
отправляется обратно.

### 2. Привязка SID к userId

Если юзер авторизован: - проверяется Redis-lock, - если нет ---
добавляется запись в `user_sids`.

### 3. Anti-Spam (главная фича)

На каждую пару `(userId, sid)` ставится Redis-lock:

    TTL = 60 сек

За это время повторная попытка привязки --- игнорируется.

### 4. Аналитика мультиаккаунтов

Есть дебаг-ручки: - SID → список пользователей - User → список его
SID'ов

------------------------------------------------------------------------

# 🏗 Архитектура и стек

### Технологии:

-   **NestJS** (DI, модули, структура)
-   **Fastify** (быстрые хуки и низкая задержка)
-   **Drizzle ORM** (типобезопасность и миграции)
-   **PostgreSQL**
-   **Redis** (anti-spam locks)
-   **Swagger**
-   **JWT**

------------------------------------------------------------------------

# 🧩 Основные компоненты

### 🎯 Fastify хуки

Порядок выполнения:

    requestIdHook → sidHook → jwtHook → sidBindHook → Controller

### 🎯 SID Binder

-   ставит Redis-lock\
-   проверяет уникальность `(userId, sid)`\
-   вставляет запись

### 🎯 Репозитории (Drizzle)

-   типобезопасные запросы\
-   минимальный boilerplate

### 🎯 Debug API

Для анализа потенцильных мультиаккаунтов:

    GET /users/sids/me
    GET /users/sids/by-sid/:sid

------------------------------------------------------------------------

# 🔄 Флоу запроса

               ┌──────────────────┐
               │ Incoming Request │
               └─────────┬────────┘
                         │
                         ▼
            ┌───────────────────────────┐
            │ requestIdHook             │
            │ генерирует requestId      │
            └──────────┬────────────────┘
                       │
                       ▼
            ┌───────────────────────────┐
            │ sidHook                   │
            │ читает/создаёт SID        │
            └──────────┬────────────────┘
                       │
                       ▼
            ┌───────────────────────────┐
            │ jwtHook (если приватный)  │
            └──────────┬────────────────┘
                       │
                       ▼
            ┌───────────────────────────┐
            │ sidBindHook               │
            │ Redis-lock + запись в БД  │
            └──────────┬────────────────┘
                       │
                       ▼
            ┌───────────────────────────┐
            │ Nest Controller           │
            └───────────────────────────┘

------------------------------------------------------------------------

# 🗂 ERD диаграмма

    ┌─────────────┐         ┌────────────────────┐
    │   users     │ 1     * │     user_sids      │
    ├─────────────┤         ├────────────────────┤
    │ id (PK)     │◄───────►│ user_id (FK→users) │
    │ email       │         │ sid                │
    │ password    │         │ created_at         │
    └─────────────┘         └────────────────────┘

------------------------------------------------------------------------

# 📡 Роуты

### Аутентификация

    POST /auth/register
    POST /auth/login
    GET  /auth/me        (требует JWT)

### SID Debug

    GET /users/sids/me            (требует JWT)
    GET /users/sids/by-sid/:sid   (требует JWT)

### Документация

    /docs
    /fastify-docs

------------------------------------------------------------------------

# 🚀 Запуск проекта

## 1. С Docker

    docker-compose up --build

Откроется по адресу:

    http://localhost:3000

Swagger:

    http://localhost:3000/docs

------------------------------------------------------------------------

# ⚙ Переменные окружения (примеры)

`.env.local (для запуска вне докера) или .env(для запуска в докере)`:

    NODE_ENV=development
    PORT=3000
    
    DATABASE_URL=postgres://postgres:postgres@localhost:5432/antifraud
    REDIS_URL=redis://localhost:6379
    
    JWT_SECRET=super-secret-local-change
    SID_BIND_TTL=60

------------------------------------------------------------------------

# 🧱 Разработка и миграции (Drizzle)

### Генерация миграций:

    yarn drizzle:generate

### Применение:

    yarn drizzle:push

### Studio:

    yarn drizzle:studio

------------------------------------------------------------------------

# 🔐 Заметки по безопасности

-   SID --- не fingerprint, но отлично ловит простых мультиаккаунтеров
-   Используется `httpOnly` cookie
-   SameSite=lax защитит от CSRF
-   Redis-lock предотвращает перегрузку БД
-   JWT проверяется только на приватных ручках
-   Swagger и статика исключены из цепочки хуков

------------------------------------------------------------------------

# 📌 Ограничения и будущее развитие

### Ограничения:

-   SID можно удалить вручную
-   Нет полноценного fingerprint browser/device
-   Нет ML-аналитики мультиаккаунтов

------------------------------------------------------------------------

# 🎉 Readme сгенерирован с любовью и скормленным проектом через Gemini :) 
